<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi File Server</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            transition: border .3s ease-in-out;
        }
        .drop-zone.dragover {
            border-color: #0d6efd;
            background: #e9ecef;
        }
        .file-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-item:hover {
            background-color: #f8f9fa;
        }
        .breadcrumb-item {
            cursor: pointer;
        }
        .breadcrumb-item:hover {
            text-decoration: underline;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <h1 class="mb-4">Pi File Server</h1>
        
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb" id="path-breadcrumb">
                <li class="breadcrumb-item active" data-path="">Home</li>
            </ol>
        </nav>

        <div class="drop-zone mb-4">
            <p class="mb-0">Drag and drop files here or click to upload</p>
            <input type="file" id="file-input" style="display: none" multiple>
        </div>

        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Size</th>
                        <th>Modified</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="file-list"></tbody>
            </table>
        </div>
    </div>

    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPath = '';
        const loading = document.querySelector('.loading');
        const dropZone = document.querySelector('.drop-zone');
        const fileInput = document.getElementById('file-input');

        function showLoading() {
            loading.style.display = 'block';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function formatSize(bytes) {
            if (bytes === null) return '-';
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 Byte';
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
        }

        function formatDate(timestamp) {
            return new Date(timestamp * 1000).toLocaleString();
        }

        function updateBreadcrumb(path) {
            const breadcrumb = document.getElementById('path-breadcrumb');
            breadcrumb.innerHTML = '<li class="breadcrumb-item" data-path="">Home</li>';
            
            if (path) {
                const parts = path.split('/');
                let currentPath = '';
                parts.forEach((part, index) => {
                    currentPath += (index === 0 ? '' : '/') + part;
                    breadcrumb.innerHTML += `
                        <li class="breadcrumb-item ${index === parts.length - 1 ? 'active' : ''}" 
                            data-path="${currentPath}">${part}</li>
                    `;
                });
            }

            breadcrumb.querySelectorAll('.breadcrumb-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (!item.classList.contains('active')) {
                        loadFiles(item.dataset.path);
                    }
                });
            });
        }

        async function loadFiles(path = '') {
            showLoading();
            try {
                const response = await fetch(`/api/files?path=${encodeURIComponent(path)}`);
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error);
                
                currentPath = data.current_path;
                updateBreadcrumb(currentPath);
                
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';
                
                data.files.sort((a, b) => {
                    if (a.is_dir === b.is_dir) return a.name.localeCompare(b.name);
                    return b.is_dir - a.is_dir;
                }).forEach(file => {
                    const tr = document.createElement('tr');
                    tr.className = 'file-item';
                    tr.innerHTML = `
                        <td>
                            <i class="bi ${file.is_dir ? 'bi-folder' : 'bi-file'} me-2"></i>
                            ${file.name}
                        </td>
                        <td>${formatSize(file.size)}</td>
                        <td>${formatDate(file.modified)}</td>
                        <td>
                            ${file.is_dir ? 
                                `<button class="btn btn-sm btn-primary me-2" onclick="loadFiles('${file.path}')">
                                    Open
                                </button>` :
                                `<a href="/api/download/${encodeURIComponent(file.path)}" 
                                    class="btn btn-sm btn-success me-2" download>
                                    Download
                                </a>`
                            }
                            <button class="btn btn-sm btn-danger" onclick="deleteFile('${file.path}')">
                                Delete
                            </button>
                        </td>
                    `;
                    fileList.appendChild(tr);
                });
            } catch (error) {
                alert('Error loading files: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function uploadFiles(files) {
            showLoading();
            for (const file of files) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('path', currentPath);

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);
                } catch (error) {
                    alert(`Error uploading ${file.name}: ${error.message}`);
                }
            }
            hideLoading();
            loadFiles(currentPath);
        }

        async function deleteFile(path) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            showLoading();
            try {
                const response = await fetch('/api/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ path })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                loadFiles(currentPath);
            } catch (error) {
                alert('Error deleting file: ' + error.message);
                hideLoading();
            }
        }

        // Event Listeners
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) uploadFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) uploadFiles(files);
            fileInput.value = '';
        });

        // Initial load
        loadFiles();
    </script>
</body>
</html>
