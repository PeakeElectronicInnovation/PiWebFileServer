<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi File Server</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            transition: border .3s ease-in-out;
        }
        .drop-zone.dragover {
            border-color: #0d6efd;
            background: #e9ecef;
        }
        .file-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-item:hover {
            background-color: #f8f9fa;
        }
        .breadcrumb-item {
            cursor: pointer;
        }
        .breadcrumb-item:hover {
            text-decoration: underline;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
        }
        .system-stats {
            font-size: 0.9rem;
        }
        .progress {
            height: 8px;
        }
        .action-icon {
            cursor: pointer;
            color: #6c757d;
            transition: color 0.2s;
        }
        .action-icon:hover {
            color: #0d6efd;
        }
        .action-icon.delete:hover {
            color: #dc3545;
        }
        .dir-name {
            cursor: pointer;
            color: #0d6efd;
        }
        .dir-name:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-md-9">
                <h1 class="mb-4">Pi File Server</h1>
                
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb" id="path-breadcrumb">
                        <li class="breadcrumb-item active" data-path="">Home</li>
                    </ol>
                </nav>

                <div class="drop-zone mb-4">
                    <p class="mb-0">Drag and drop files here or click to upload</p>
                    <input type="file" id="file-input" style="display: none" multiple>
                </div>

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Modified</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="file-list"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        System Information
                    </div>
                    <div class="card-body system-stats">
                        <h6 class="card-subtitle mb-2 text-muted" id="hostname">Loading...</h6>
                        <p class="card-text" id="ip-address"></p>
                        <p class="card-text" id="uptime"></p>
                        
                        <h6 class="mt-3 mb-2">CPU Usage</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar" id="cpu-bar" role="progressbar"></div>
                        </div>
                        <p class="card-text" id="cpu-usage"></p>
                        
                        <h6 class="mt-3 mb-2">Memory Usage</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar" id="ram-bar" role="progressbar"></div>
                        </div>
                        <p class="card-text" id="ram-usage"></p>
                        
                        <h6 class="mt-3 mb-2">Disk Usage</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar" id="disk-bar" role="progressbar"></div>
                        </div>
                        <p class="card-text" id="disk-usage"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPath = '';
        const loading = document.querySelector('.loading');
        const dropZone = document.querySelector('.drop-zone');
        const fileInput = document.getElementById('file-input');

        function showLoading() {
            loading.style.display = 'block';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function formatSize(bytes) {
            if (bytes === null) return '-';
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 Byte';
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
        }

        function formatDate(timestamp) {
            return new Date(timestamp * 1000).toLocaleString();
        }

        function updateSystemStats() {
            fetch('/api/system-stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('hostname').textContent = data.hostname;
                    document.getElementById('ip-address').textContent = `IP: ${data.ip_address}`;
                    document.getElementById('uptime').textContent = `Uptime: ${data.uptime}`;
                    
                    document.getElementById('cpu-usage').textContent = data.cpu_usage;
                    document.getElementById('cpu-bar').style.width = data.cpu_usage;
                    
                    document.getElementById('ram-usage').textContent = 
                        `${data.ram_used} / ${data.ram_total} (${data.ram_percent})`;
                    document.getElementById('ram-bar').style.width = data.ram_percent;
                    
                    document.getElementById('disk-usage').textContent = 
                        `${data.disk_used} / ${data.disk_total} (${data.disk_percent})`;
                    document.getElementById('disk-bar').style.width = data.disk_percent;
                });
        }

        function updateBreadcrumb(path) {
            const breadcrumb = document.getElementById('path-breadcrumb');
            breadcrumb.innerHTML = '<li class="breadcrumb-item" data-path="">Home</li>';
            
            if (path) {
                const parts = path.split('/');
                let currentPath = '';
                parts.forEach((part, index) => {
                    currentPath += (index === 0 ? '' : '/') + part;
                    breadcrumb.innerHTML += `
                        <li class="breadcrumb-item ${index === parts.length - 1 ? 'active' : ''}" 
                            data-path="${currentPath}">${part}</li>
                    `;
                });
            }

            breadcrumb.querySelectorAll('.breadcrumb-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (!item.classList.contains('active')) {
                        loadFiles(item.dataset.path);
                    }
                });
            });
        }

        async function loadFiles(path = '') {
            showLoading();
            try {
                const response = await fetch(`/api/files?path=${encodeURIComponent(path)}`);
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error);
                
                currentPath = data.current_path;
                updateBreadcrumb(currentPath);
                
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';
                
                data.files.sort((a, b) => {
                    if (a.is_dir === b.is_dir) return a.name.localeCompare(b.name);
                    return b.is_dir - a.is_dir;
                }).forEach(file => {
                    const tr = document.createElement('tr');
                    tr.className = 'file-item';
                    tr.innerHTML = `
                        <td>
                            <i class="bi ${file.is_dir ? 'bi-folder' : 'bi-file'} me-2"></i>
                            ${file.is_dir ? 
                                `<span class="dir-name" onclick="loadFiles('${file.path}')">${file.name}</span>` :
                                file.name
                            }
                        </td>
                        <td>${formatSize(file.size)}</td>
                        <td>${formatDate(file.modified)}</td>
                        <td class="text-end">
                            ${file.is_dir ? '' : 
                                `<i class="bi bi-download action-icon me-3" 
                                    onclick="window.location.href='/api/download/${encodeURIComponent(file.path)}'" 
                                    title="Download"></i>`
                            }
                            <i class="bi bi-trash action-icon delete" 
                               onclick="deleteFile('${file.path}')" 
                               title="Delete"></i>
                        </td>
                    `;
                    fileList.appendChild(tr);
                });
            } catch (error) {
                alert('Error loading files: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function uploadFiles(files) {
            showLoading();
            for (const file of files) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('path', currentPath);

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);
                } catch (error) {
                    alert(`Error uploading ${file.name}: ${error.message}`);
                }
            }
            hideLoading();
            loadFiles(currentPath);
        }

        async function deleteFile(path) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            showLoading();
            try {
                const response = await fetch('/api/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ path })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                loadFiles(currentPath);
            } catch (error) {
                alert('Error deleting file: ' + error.message);
                hideLoading();
            }
        }

        // Event Listeners
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) uploadFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) uploadFiles(files);
            fileInput.value = '';
        });

        // Initial load
        loadFiles();
        updateSystemStats();
        
        // Update system stats every 5 seconds
        setInterval(updateSystemStats, 5000);
    </script>
</body>
</html>
